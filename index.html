<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OAuth Callback</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: linear-gradient(180deg,#3b3a8a,#2a1f5a); color: #fff; display:flex; align-items:center; justify-content:center; height:100vh; margin:0 }
    .card{ background: rgba(255,255,255,0.06); padding:20px; border-radius:12px; max-width:720px; width:92%; box-shadow:0 8px 30px rgba(0,0,0,0.25); }
    h1{ margin:0 0 12px 0; font-size:20px }
    p{ margin:0 0 8px 0; color:rgba(255,255,255,0.9) }
    code{ display:block; word-break:break-all; background:rgba(0,0,0,0.18); padding:8px; border-radius:8px; margin-top:8px }
    a.button{ display:inline-block; margin-top:12px; padding:8px 12px; background:#fff;color:#111;border-radius:8px; text-decoration:none }
  </style>
</head>
<body>
  <div class="card" id="card">
    <h1>Signing you inâ€¦</h1>
    <p id="message">Processing OAuth response and redirecting back to the app.</p>
    <div id="debug" style="display:none">
      <p>Authorization Data:</p>
      <code id="authdata">-</code>
      <a id="manual" class="button" href="#">Open app manually</a>
    </div>
  </div>

  <script>
    (function (){
      // Read query parameters and fragment
      function parseFragmentHash(hash) {
        if (!hash) return {};
        // remove leading '#'
        var h = hash[0] === '#' ? hash.substring(1) : hash;
        try {
          return Object.fromEntries(new URLSearchParams(h));
        } catch (e) {
          return {};
        }
      }

      var params = Object.fromEntries(new URLSearchParams(window.location.search));
      var frag = parseFragmentHash(window.location.hash);

      // prefer code (authorization code flow)
      var code = params['code'] || null;
      var accessToken = frag['access_token'] || params['access_token'] || null;
      var error = params['error'] || frag['error'] || null;

      var debugEl = document.getElementById('debug');
      var authdata = document.getElementById('authdata');
      var manual = document.getElementById('manual');
      var message = document.getElementById('message');

      function redirectToApp(url) {
        // Try to open the app custom scheme. Use replace so history is not polluted.
        window.location.replace(url);
      }

      if (error) {
        message.textContent = 'OAuth returned an error: ' + error;
        authdata.textContent = JSON.stringify({error: error, params: params, fragment: frag}, null, 2);
        debugEl.style.display = 'block';
      } else if (code) {
        // Redirect with query param
        var appUrl = 'integritas://oauth-callback?code=' + encodeURIComponent(code);
        authdata.textContent = 'code=' + code;
        debugEl.style.display = 'block';
        manual.href = appUrl;
        // Perform redirect after a short pause to show message
        setTimeout(function(){ redirectToApp(appUrl); }, 600);
      } else if (accessToken) {
        // Redirect with fragment so token remains in fragment if needed
        var appUrlToken = 'integritas://oauth-callback#access_token=' + encodeURIComponent(accessToken);
        authdata.textContent = 'access_token=' + accessToken;
        debugEl.style.display = 'block';
        manual.href = appUrlToken;
        setTimeout(function(){ redirectToApp(appUrlToken); }, 600);
      } else {
        // No auth data found - show help
        message.textContent = 'No authorization data found in the URL. If you see an authorization code shown on-screen, click the button to open the app.';
        // Show possible code contained in url path or body
        authdata.textContent = 'search=' + window.location.search + '\nfragment=' + window.location.hash;
        debugEl.style.display = 'block';
        manual.href = 'integritas://oauth-callback';
      }
    })();
  </script>
</body>
</html>
