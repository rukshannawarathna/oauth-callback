<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OAuth Callback</title>
  <style>
    :root {
      --bg1: #3b3a8a;
      --bg2: #2a1f5a;
      --card-bg: rgba(255,255,255,0.06);
      --text: #ffffff;
      --muted: rgba(255,255,255,0.85);
      --button-bg: #ffffff;
      --button-text: #111;
      --max-width: 720px;
    }
    html,body { height:100%; margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-font-smoothing:antialiased; }
    body {
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      box-sizing:border-box;
      min-height:100vh;
    }
    .card{
      background: var(--card-bg);
      padding:22px;
      border-radius:14px;
      max-width:var(--max-width);
      width:100%;
      box-shadow:0 12px 36px rgba(0,0,0,0.28);
      box-sizing:border-box;
      text-align:left;
    }
    .card h1{ margin:0 0 8px 0; font-size:20px; line-height:1.1; }
    .card p { margin:0 0 12px 0; color:var(--muted); font-size:15px; }
    .button {
      display:inline-block;
      margin:0 auto;
      padding:12px 18px;
      background:var(--button-bg);
      color:var(--button-text);
      border-radius:10px;
      text-decoration:none;
      font-weight:600;
      border:0;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
      cursor:pointer;
    }
    .actions {
      display:flex;
      justify-content:center;
      margin-top:16px;
    }
    /* small screens: card should breathe better */
    @media (max-width:420px) {
      .card{ padding:18px; border-radius:12px; }
      .card h1{ font-size:18px; }
      .card p{ font-size:14px; }
    }
  </style>
</head>
<body>
  <div class="card" id="card">
    <h1>Signing you in…</h1>
    <p id="message">Processing OAuth response and attempting to open the app.</p>

    <!-- Manual open button (hidden until needed) -->
    <div class="actions">
      <a id="manual" class="button" href="#" style="display:none">Open app manually</a>
    </div>
  </div>

  <script>
    (function (){
      // Read query parameters and fragment
      function parseFragmentHash(hash) {
        if (!hash) return {};
        var h = hash[0] === '#' ? hash.substring(1) : hash;
        try {
          return Object.fromEntries(new URLSearchParams(h));
        } catch (e) {
          return {};
        }
      }

      var params = Object.fromEntries(new URLSearchParams(window.location.search));
      var frag = parseFragmentHash(window.location.hash);

      // prefer code (authorization code flow)
      var code = params['code'] || null;
      var accessToken = frag['access_token'] || params['access_token'] || null;
      var error = params['error'] || frag['error'] || null;

      var manual = document.getElementById('manual');
      var message = document.getElementById('message');

      function redirectToApp(url) {
        window.location.replace(url);
      }

      var autoOpened = false;

      function showFallback(appUrl) {
        // Show manual button when automatic redirect didn't work.
        manual.href = appUrl;
        manual.style.display = 'inline-block';
        message.textContent = 'Tap "Open app manually" if nothing happened.';
      }

      function tryOpenApp(appUrl) {
        try {
          // hidden iframe can work on some platforms
          var iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = appUrl;
          document.body.appendChild(iframe);

          // direct navigation as a fallback
          window.location.replace(appUrl);
        } catch (e) {
          // ignore failures to attempt silent open
        }
      }

      function handleVisibility() {
        if (document.hidden) {
          autoOpened = true;
          message.textContent = 'Opened app — returning you shortly.';
          try { window.close(); } catch (e) {}
        }
      }

      document.addEventListener('visibilitychange', handleVisibility, false);
      window.addEventListener('pagehide', function() { autoOpened = true; }, false);

      if (error) {
        message.textContent = 'OAuth returned an error.';
        showFallback('integritas://oauth-callback');
      } else if (code) {
        var appUrl = 'integritas://oauth-callback?code=' + encodeURIComponent(code);
        tryOpenApp(appUrl);
        setTimeout(function(){ if (!autoOpened) showFallback(appUrl); }, 1000);
      } else if (accessToken) {
        var appUrlToken = 'integritas://oauth-callback#access_token=' + encodeURIComponent(accessToken);
        tryOpenApp(appUrlToken);
        setTimeout(function(){ if (!autoOpened) showFallback(appUrlToken); }, 1000);
      } else {
        // No auth data found - show manual fallback
        showFallback('integritas://oauth-callback');
      }
    })();
  </script>
</body>
</html>
